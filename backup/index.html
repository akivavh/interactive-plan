<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktiver Lernplan: AP2 Systemintegration (Diseño Mejorado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f4f8; /* slate-100 */
            --card-bg: #ffffff;
            --text-main: #1e293b; /* slate-800 */
            --text-light: #64748b; /* slate-500 */
            --border-color: #e2e8f0; /* slate-200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
        }
       .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
       .accordion-button.open ~ .accordion-content {
            max-height: 5000px; 
            padding-top: 0.5rem;
            padding-bottom: 1.5rem;
        }
       .progress-bar-bg { background-color: #e2e8f0; }
       .progress-bar-fill { transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
       .rotate-180 { transform: rotate(180deg); }
       .transition-all { transition: all 0.3s ease-in-out; }
       .card {
           background-color: var(--card-bg);
           border-radius: 1rem; 
           box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
           border: 1px solid var(--border-color);
       }
       .milestone-checkbox:checked + span {
           text-decoration: line-through;
           color: var(--text-light);
       }
       .status-selector { position: relative; }
       .status-options {
           display: none;
           position: absolute;
           right: 0;
           top: 100%;
           margin-top: 0.25rem;
           background-color: white;
           border: 1px solid var(--border-color);
           border-radius: 0.5rem;
           box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
           z-index: 20; 
           width: 150px;
       }
       .status-options.visible { display: block; }
       .status-option {
           display: flex;
           align-items: center;
           padding: 0.5rem 0.75rem;
           cursor: pointer;
           font-size: 0.875rem;
       }
       .status-option:hover { background-color: #f8fafc; }
       .status-dot {
           width: 0.75rem;
           height: 0.75rem;
           border-radius: 9999px;
           margin-right: 0.5rem;
       }
       .source-pill {
            transition: all 0.2s ease-in-out;
       }
       .source-pill .source-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
       }
       .source-pill:hover .source-actions {
            opacity: 1;
       }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        
        <header class="mb-10 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900">Dein Interaktiver Lernplan</h1>
            <p class="text-lg text-slate-600 mt-2">Vorbereitung zur Abschlussprüfung Teil 2 - Fachinformatiker Systemintegration</p>
        </header>

        <div class="card p-6 mb-8">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Gesamtfortschritt (Lerninhalte)</h2>
            <div class="flex items-center gap-4">
                <div class="w-full progress-bar-bg rounded-full h-5">
                    <div id="overall-progress-bar" class="progress-bar-fill h-5 rounded-full bg-gradient-to-r from-sky-400 to-blue-500"></div>
                </div>
                <span id="overall-progress-text" class="font-bold text-xl text-slate-700 w-14 text-right">0%</span>
            </div>
        </div>
        
        <div id="accordion-container" class="space-y-4">
            <!-- Learning topics for written exams will be rendered here -->
        </div>

        <div class="card my-8">
            <div class="accordion-button w-full flex items-center p-5 text-left font-bold text-lg hover:bg-slate-50 focus:outline-none transition-all cursor-pointer">
                <div class="flex items-center gap-4 flex-grow">
                    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <span class="text-slate-800">Betriebliche Projektarbeit</span>
                </div>
                <svg class="chevron-icon w-6 h-6 transition-transform text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="accordion-content">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-full progress-bar-bg rounded-full h-4">
                        <div id="project-milestone-progress-bar" class="progress-bar-fill h-4 rounded-full bg-gradient-to-r from-indigo-400 to-purple-500"></div>
                    </div>
                    <span id="project-milestone-progress-text" class="font-bold text-lg text-slate-700">0%</span>
                </div>
                <div id="project-milestones-container" class="space-y-4">
                    <!-- Project milestones will be rendered here -->
                </div>
                 <div class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg">
                     <h5 class="font-semibold text-sky-800 mb-2">Wichtige Fähigkeiten für die Dokumentation</h5>
                     <p class="text-sm text-sky-700">Diese Fähigkeiten sind keine direkten Themen der schriftlichen Prüfung, aber entscheidend für eine gute Note in deiner Projektdokumentation. Du musst sie anwenden, um deine Arbeit professionell zu visualisieren und zu beschreiben.</p>
                     <ul class="mt-2 ml-4 list-disc list-outside text-sky-700 text-sm space-y-1">
                         <li><strong>UML-Diagramme:</strong> Use-Case- und Aktivitätsdiagramme zur Visualisierung von Anforderungen und Prozessen.</li>
                         <li><strong>Netzwerkpläne:</strong> Logische und physische Pläne zur Darstellung der Systemarchitektur.</li>
                         <li><strong>Wirtschaftlichkeitsbetrachtung:</strong> Eine einfache Kosten-Nutzen-Analyse deines Projekts.</li>
                     </ul>
                 </div>
            </div>
        </div>

        <footer class="mt-12">
            <div class="card">
                 <div class="accordion-button w-full flex items-center p-5 text-left font-bold text-lg hover:bg-slate-50 focus:outline-none transition-all cursor-pointer">
                     <div class="flex items-center gap-4 flex-grow">
                         <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-slate-100 text-slate-600 flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m-4 3V5a2 2 0 012-2h2" /></svg>
                         </div>
                         <span class="text-slate-800">Bauplan der Prüfungsinhalte & Quellen</span>
                     </div>
                     <svg class="chevron-icon w-6 h-6 transition-transform text-slate-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                 </div>
                 <div class="accordion-content">
                     <p class="text-slate-600 mb-4">Dieser Lernplan ist nicht willkürlich, sondern basiert auf einer sorgfältigen Analyse der offiziellen Vorgaben. Hier ist transparent aufgeschlüsselt, wie die Inhalte zustande kommen:</p>
                     <div class="space-y-6">
                         <div>
                             <h4 class="font-semibold text-slate-800 mb-2">1. Das Fundament: Die Ausbildungsverordnung (FIAusbV)</h4>
                             <p class="text-sm text-slate-600">Die <a href="https://www.gesetze-im-internet.de/fiausbv/BJNR025000020.html" target="_blank" class="text-blue-600 hover:underline">FIAusbV</a> ist das Gesetz, das die Prüfung regelt. Gemäß <strong class="text-slate-900">§ 16 Absatz 2</strong> legt sie die Struktur der Abschlussprüfung Teil 2 fest.</p>
                         </div>
                         <div>
                             <h4 class="font-semibold text-slate-800 mb-2">2. Die Details: Der IHK-Prüfungskatalog</h4>
                             <p class="text-sm text-slate-600">Der offizielle <a href="https://www.u-form-shop.de/ihk-pruefungskataloge/abschlusspruefung/fachinformatiker-in-fachrichtung-systemintegration" target="_blank" class="text-blue-600 hover:underline">IHK-Prüfungskatalog</a> füllt die gesetzlichen Vorgaben mit Leben und listet die konkreten Themen auf, die in den schriftlichen Prüfungen abgefragt werden.</p>
                         </div>
                         <div>
                             <h4 class="font-semibold text-slate-800 mb-2">3. Die Tiefe: Das IT-Handbuch als Wissensbasis</h4>
                             <p class="text-sm text-slate-600">Während die FIAusbV das "Was" und der IHK-Katalog das "Welche Themen" vorgibt, liefert das <a href="https://openbook.rheinwerk-verlag.de/it_handbuch/" target="_blank" class="text-blue-600 hover:underline">IT-Handbuch für Fachinformatiker</a> das "Wie" und "Warum".</p>
                         </div>
                     </div>
                 </div>
            </div>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const statusOptions = [
            { Status: "Startklar", Percent: 0, color: "bg-slate-400" },
            { Status: "In Arbeit", Percent: 50, color: "bg-blue-500" },
            { Status: "Gemeistert!", Percent: 100, color: "bg-teal-500" }
        ];

        const projectMilestones_default = [
            { text: "Phase 1: Projektantrag", completed: false, details: ["Thema definieren", "Projektziele festlegen", "Zeitplan erstellen", "Antrag formulieren und einreichen"] },
            { text: "Phase 2: Projektdurchführung", completed: false, details: ["Systeme beschaffen und installieren", "Netzwerk konfigurieren", "Dienste einrichten", "Tests durchführen"] },
            { text: "Phase 3: Projektdokumentation", completed: false, details: ["Ist-Analyse und Soll-Konzept beschreiben", "Technische Umsetzung dokumentieren", "Diagramme (z.B. UML, Netzwerkplan) erstellen", "Wirtschaftlichkeitsbetrachtung durchführen"] },
            { text: "Phase 4: Präsentation & Fachgespräch", completed: false, details: ["Präsentation erstellen", "Vortrag üben", "Auf mögliche Fragen im Fachgespräch vorbereiten", "Prüfung absolvieren"] }
        ];
        
        const topicsData_default = [
            { "Bereich": "A: Planen eines Systemintegrationsprojektes", "Thema": "Stakeholder- & Anforderungsanalyse", "Lerninhalte": [
                { text: "Stakeholder identifizieren und analysieren", status: "Startklar" }, { text: "Kundenbedarfe zielgruppengerecht ermitteln (Interviews, Workshops)", status: "Startklar" }, { text: "Geschäftsprozesse und Ist-Zustand analysieren", status: "Startklar" }, { text: "Anforderungen sammeln, präzisieren, dokumentieren und priorisieren", status: "Startklar" }
            ], "Quellen": [] },
            { "Bereich": "A: Planen eines Systemintegrationsprojektes", "Thema": "Lastenheft & Pflichtenheft", "Lerninhalte": [
                { text: "Lastenheft erstellen (Ziele, Ausgangssituation, Rahmenbedingungen)", status: "Startklar" }, { text: "Funktionale & nicht-funktionale Anforderungen definieren", status: "Startklar" }, { text: "Pflichtenheft erstellen (detailliertes Lösungskonzept, Systemarchitektur)", status: "Startklar" }, { text: "Messbare Abnahmekriterien für das Projekt festlegen", status: "Startklar" }
            ], "Quellen": [] },
            { "Bereich": "A: Planen eines Systemintegrationsprojektes", "Thema": "Projektplanung & -steuerung", "Lerninhalte": [
                { text: "Projektziele nach der SMART-Formel formulieren", status: "Startklar" }, { text: "Projektstrukturplan (PSP) in Arbeitspakete gliedern", status: "Startklar" }, { text: "Aufwand mit Schätzverfahren ermitteln", status: "Startklar" }, { text: "Kosten und Ressourcen planen (Magisches Dreieck)", status: "Startklar" }
            ], "Quellen": [] },
            { "Bereich": "A: Planen eines Systemintegrationsprojektes", "Thema": "Risikomanagement & Alternativen", "Lerninhalte": [
                { text: "Projektrisiken identifizieren, bewerten und Maßnahmen planen", status: "Startklar" }, { text: "Technische Lösungsalternativen entwickeln und bewerten", status: "Startklar" }, { text: "Make-or-Buy-Entscheidung treffen und begründen (Nutzwertanalyse)", status: "Startklar" }
            ], "Quellen": [] },
            { "Bereich": "A: Planen eines Systemintegrationsprojektes", "Thema": "Sicherheitskonzeption", "Lerninhalte": [
                { text: "Sicherheitsanforderungen für das System analysieren", status: "Startklar" }, { text: "Mögliche Bedrohungen und Schadenspotenziale identifizieren", status: "Startklar" }, { text: "Sicherheitskonzept (techn./organisator. Maßnahmen) ableiten", status: "Startklar" }, { text: "Maßnahmen zu IT-Sicherheit und Datenschutz umsetzen", status: "Startklar" }
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Server-Hardware & Betriebssysteme", "Lerninhalte": [
                { text: "Server-Hardware passend zu Anforderungen auswählen (CPU, RAM, Speicher)", status: "Startklar" }, { text: "Server-Betriebssysteme (Linux, Windows) installieren und grundlegend konfigurieren", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Serverdienste", "Lerninhalte": [
                { text: "DNS-Server installieren und konfigurieren", status: "Startklar" }, { text: "DHCP-Server installieren und konfigurieren", status: "Startklar" }, { text: "Verzeichnisdienste (z.B. Active Directory) installieren und konfigurieren", status: "Startklar" },
            ], "Quellen": [] },
             { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Speicherlösungen", "Lerninhalte": [
                { text: "RAID-Level verstehen und anwendungsbezogen auswählen (0, 1, 5, 10)", status: "Startklar" }, { text: "Speicherlösungen unterscheiden (DAS, NAS, SAN)", status: "Startklar" }, { text: "Zugriffsprotokolle für Speicher kennen (SMB, NFS, iSCSI)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Virtualisierung & Container", "Lerninhalte": [
                { text: "Hypervisor-Typen unterscheiden (Typ 1 vs. Typ 2)", status: "Startklar" }, { text: "Virtuelle Maschinen (VMs) erstellen, konfigurieren und verwalten", status: "Startklar" }, { text: "Unterschied zwischen VMs und Containern (Docker) erklären", status: "Startklar" },
            ], "Quellen": [] },
             { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Benutzer- & Rechteverwaltung", "Lerninhalte": [
                { text: "Benutzerkonten und Gruppen verwalten", status: "Startklar" }, { text: "Berechtigungskonzepte umsetzen (Prinzip der geringsten Rechte)", status: "Startklar" }, { text: "Authentifizierungsmethoden kennen (MFA, SSO)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Automatisierung & Backup", "Lerninhalte": [
                { text: "Shell-Skripte (Bash) oder PowerShell-Skripte erstellen", status: "Startklar" }, { text: "Backup-Strategien unterscheiden (Voll, Inkrementell, Differentiell)", status: "Startklar" }, { text: "Die 3-2-1-Backup-Regel anwenden", status: "Startklar" }, { text: "Wiederherstellungsplan (Disaster Recovery) erstellen", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Monitoring & Datenbanken", "Lerninhalte": [
                { text: "Systemressourcen überwachen (SNMP, WMI)", status: "Startklar" }, { text: "Protokolldateien zentral sammeln und auswerten (Syslog)", status: "Startklar" }, { text: "SQL-Befehle anwenden (SELECT, INSERT, UPDATE, DELETE, JOIN)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "B: Konzeption & Administration von IT-Systemen", "Thema": "Cloud Computing", "Lerninhalte": [
                { text: "Cloud-Servicemodelle unterscheiden (IaaS, PaaS, SaaS)", status: "Startklar" }, { text: "Cloud-Bereitstellungsmodelle unterscheiden (Public, Private, Hybrid)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "C: Analyse & Entwicklung von Netzwerken", "Thema": "Netzwerkgrundlagen", "Lerninhalte": [
                { text: "OSI-Referenzmodell und TCP/IP-Schichtenmodell erklären", status: "Startklar" }, { text: "Wichtige Protokolle den Schichten zuordnen (IP, TCP, UDP, HTTP, DNS etc.)", status: "Startklar" }, { text: "Funktion von Netzwerkgeräten erklären (Switch, Router, AP, Firewall)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "C: Analyse & Entwicklung von Netzwerken", "Thema": "IP-Adressierung", "Lerninhalte": [
                { text: "IPv4-Subnetting und CIDR anwenden", status: "Startklar" }, { text: "IPv6-Adressaufbau verstehen", status: "Startklar" }, { text: "IPv6-Adressen mit Kürzungsregeln vereinfachen", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "C: Analyse & Entwicklung von Netzwerken", "Thema": "Switching & Routing", "Lerninhalte": [
                { text: "Zweck und Konfiguration von VLANs (802.1Q) erklären", status: "Startklar" }, { text: "Statisches und dynamisches Routing unterscheiden", status: "Startklar" }, { text: "Funktion von NAT und PAT erklären", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "C: Analyse & Entwicklung von Netzwerken", "Thema": "Netzwerksicherheit", "Lerninhalte": [
                { text: "WLAN-Sicherheitsstandards vergleichen (WPA2, WPA3)", status: "Startklar" }, { text: "Firewall-Typen und das Konzept einer DMZ erklären", status: "Startklar" }, { text: "Unterschied zwischen IDS und IPS erklären", status: "Startklar" }, { text: "Funktion von digitalen Zertifikaten und PKI beschreiben", status: "Startklar" }, { text: "VPN-Typen kennen (Site-to-Site, Remote Access)", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "C: Analyse & Entwicklung von Netzwerken", "Thema": "Redundanz & Management", "Lerninhalte": [
                { text: "Link Aggregation (LACP) und Spanning Tree Protocol (STP) verstehen", status: "Startklar" }, { text: "First Hop Redundancy (HSRP, VRRP) verstehen", status: "Startklar" }, { text: "Incident-Management-Prozess (ITIL-Grundlagen) beschreiben", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "D: Wirtschafts- & Sozialkunde", "Thema": "Ausbildung & Arbeitswelt", "Lerninhalte": [
                { text: "Rechte und Pflichten im Ausbildungsverhältnis kennen", status: "Startklar" }, { text: "Regelungen zur Kündigung kennen", status: "Startklar" }, { text: "Aufgaben und Rechte des Betriebsrats beschreiben", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "D: Wirtschafts- & Sozialkunde", "Thema": "Soziales & Wirtschaftliches System", "Lerninhalte": [
                { text: "Fünf Säulen der Sozialversicherung aufzählen", status: "Startklar" }, { text: "Prinzip von Angebot und Nachfrage erklären", status: "Startklar" }, { text: "Konzept der sozialen Marktwirtschaft beschreiben", status: "Startklar" }, { text: "Phasen des Konjunkturzyklus benennen", status: "Startklar" },
            ], "Quellen": [] },
            { "Bereich": "D: Wirtschafts- & Sozialkunde", "Thema": "Unternehmen & Recht", "Lerninhalte": [
                { text: "Rechtsformen von Unternehmen unterscheiden (insb. Haftung)", status: "Startklar" }, { text: "Finanzierungsarten kennen (Eigen- vs. Fremdfinanzierung)", status: "Startklar" }, { text: "Grundstruktur einer Bilanz verstehen", status: "Startklar" }, { text: "Vier Grundfreiheiten des EU-Binnenmarktes aufzählen", status: "Startklar" },
            ], "Quellen": [] },
        ].map((topic, index) => ({...topic, id: `topic-${index}`}));

        let db, auth, userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let topicsData = [];
        let projectMilestones = [];
        let saveTimeout;
        let unsubscribe; 
        let isUiInitialized = false;

        async function saveStateToFirestore() {
            if (!userId || !isUiInitialized) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId);
                    await setDoc(docRef, {
                        studyPlanV12: {
                            topicsData: topicsData,
                            projectMilestones: projectMilestones
                        }
                    });
                } catch (error) {
                    console.error("Fehler beim Speichern in Firestore: ", error);
                }
            }, 1500); 
        }

        function initializeUI(data) {
            isUiInitialized = true;
            topicsData = data.topicsData.map(topic => ({...topic, Quellen: topic.Quellen || []}));
            projectMilestones = data.projectMilestones;
            renderProjectMilestones();
            renderLearningTopics();
            addEventListeners();
            updateAllProgress();
            updateProjectProgress();
        }
        
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        if (unsubscribe) unsubscribe();

                        const docRef = doc(db, 'artifacts', appId, 'users', userId);
                        unsubscribe = onSnapshot(docRef, (docSnap) => {
                            if (!isUiInitialized) {
                                const data = docSnap.exists() ? docSnap.data().studyPlanV12 : null;
                                if (data && data.topicsData && data.projectMilestones) {
                                    initializeUI(data);
                                } else {
                                    initializeUI({ topicsData: JSON.parse(JSON.stringify(topicsData_default)), projectMilestones: JSON.parse(JSON.stringify(projectMilestones_default)) });
                                    saveStateToFirestore();
                                }
                            }
                        });
                    } else {
                        userId = null;
                        if(unsubscribe) unsubscribe();
                        isUiInitialized = false;
                    }
                });

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialisierung fehlgeschlagen:", error);
                initializeUI({ topicsData: JSON.parse(JSON.stringify(topicsData_default)), projectMilestones: JSON.parse(JSON.stringify(projectMilestones_default)) });
            }
        }

        initFirebase();
        
        function renderProjectMilestones() {
            const container = document.getElementById('project-milestones-container');
            container.innerHTML = projectMilestones.map((milestone, index) => `
                <div class="p-2">
                    <label class="flex items-center space-x-3 cursor-pointer font-semibold">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 milestone-checkbox" data-index="${index}" ${milestone.completed ? 'checked' : ''}>
                        <span class="text-gray-800">${milestone.text}</span>
                    </label>
                    <ul class="mt-2 ml-8 list-disc list-outside text-gray-600 text-sm space-y-1">
                        ${milestone.details.map(detail => `<li>${detail}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        function renderLearningTopics() {
            const accordionContainer = document.getElementById('accordion-container');
            if (!accordionContainer) return;
            accordionContainer.innerHTML = ''; 

            const groupedTopics = topicsData.reduce((acc, topic) => {
                const bereich = topic.Bereich;
                if (!acc[bereich]) {
                    acc[bereich] = [];
                }
                acc[bereich].push(topic);
                return acc;
            }, {});

            const sectionColors = {
                "A": "from-sky-400 to-blue-500",
                "B": "from-teal-400 to-emerald-500",
                "C": "from-amber-400 to-orange-500",
                "D": "from-rose-400 to-pink-500",
            };

            Object.entries(groupedTopics).forEach(([bereich, topics], index) => {
                const sectionKey = bereich.charAt(0);
                const colorClass = sectionColors[sectionKey] || "from-slate-400 to-slate-500";
                const accordionItem = createAccordionItem(bereich, topics, index, colorClass);
                accordionContainer.appendChild(accordionItem);
            });
        }
        
        function createMasterSelector(type, identifier) {
             return `
                <div class="${type}-selector status-selector" data-identifier="${identifier}">
                    <button class="status-selector-button flex items-center justify-center h-8 w-8 rounded-full hover:bg-slate-200 text-slate-500 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        </svg>
                    </button>
                    <div class="status-options">
                        ${statusOptions.map(option => `
                            <div class="status-option" data-status="${option.Status}">
                                <span class="status-dot ${option.color}"></span>
                                <span>${option.Status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createAccordionItem(bereich, topics, index, colorClass) {
            const sectionId = `section-${index}`;
            const sectionKey = bereich.charAt(0);
            const icon = getIconForSection(sectionKey);
            const item = document.createElement('div');
            item.className = 'card';
            
            const sectionMasterStatusSelector = createMasterSelector('section-master', bereich);

            item.innerHTML = `
                <div class="accordion-button w-full flex items-center p-5 text-left font-bold text-lg hover:bg-slate-50 focus:outline-none transition-all cursor-pointer">
                    <div class="flex items-center gap-4 flex-grow">
                        ${icon}
                        <span class="text-slate-800">${bereich}</span>
                    </div>
                    <svg class="chevron-icon w-6 h-6 transition-transform text-slate-500 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="px-5 pb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-full progress-bar-bg rounded-full h-2.5">
                            <div id="progress-bar-${sectionId}" class="progress-bar-fill h-2.5 rounded-full bg-gradient-to-r ${colorClass}"></div>
                        </div>
                        ${sectionMasterStatusSelector}
                    </div>
                </div>
                <div id="${sectionId}" class="accordion-content">
                    <div class="space-y-4">
                        ${topics.map(topic => createTopicItem(topic)).join('')}
                    </div>
                </div>
            `;
            return item;
        }
        
        function getIconForSection(key) {
            const icons = {
                "A": `<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></div>`,
                "B": `<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg></div>`,
                "C": `<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg></div>`,
                "D": `<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-rose-100 text-rose-600 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div>`,
            }
            return icons[key] || '';
        }

        function createTopicItem(topic) {
            const topicMasterStatusSelector = createMasterSelector('topic-master', topic.id);

            return `
                <div class="topic-item bg-slate-50/50 border border-slate-200/80 rounded-xl p-4" data-topic-id="${topic.id}">
                    <div class="flex justify-between items-center gap-4 mb-4">
                         <h4 class="font-semibold text-slate-700 flex-grow">${topic.Thema}</h4>
                         <div class="flex items-center gap-3 flex-shrink-0">
                             <div class="w-24 progress-bar-bg rounded-full h-2">
                                 <div class="topic-progress-bar progress-bar-fill h-2 rounded-full"></div>
                             </div>
                             <span class="topic-progress-text font-medium text-xs text-slate-500 w-8 text-right">0%</span>
                             ${topicMasterStatusSelector}
                         </div>
                    </div>
                    <div class="space-y-3 pl-2 border-t border-slate-200/80 pt-4">
                        ${topic.Lerninhalte.map((inhalt, index) => createLerninhaltItem(topic.id, inhalt, index)).join('')}
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200/80">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-sm font-semibold text-slate-600">Quellen</h5>
                            <button class="add-source-btn text-sm font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Add Quellen
                            </button>
                        </div>
                        <div class="sources-container space-y-2">
                            ${(topic.Quellen || []).map((source, index) => createSourcePill(source, index)).join('')}
                        </div>
                        <div class="add-source-form hidden mt-2 space-y-2" data-editing-index="-1">
                            <input type="text" class="source-description-input w-full p-2 border border-slate-300 rounded-md" placeholder="Beschreibung (z.B. IT-Handbuch Kap. 5)">
                            <input type="text" class="source-link-input w-full p-2 border border-slate-300 rounded-md" placeholder="Link (optional)">
                            <div class="flex justify-end gap-2">
                                <button class="cancel-source-btn text-sm font-semibold py-1 px-3 rounded-md hover:bg-slate-100">Abbrechen</button>
                                <button class="save-source-btn text-sm font-semibold py-1 px-3 rounded-md bg-blue-600 text-white hover:bg-blue-700">Speichern</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function createSourcePill(source, index) {
            const isLink = source.link && source.link.startsWith('http');
            const icon = isLink 
                ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>`
                : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`;
            
            const content = isLink 
                ? `<a href="${source.link}" target="_blank" class="hover:underline">${source.description}</a>`
                : `<span>${source.description}</span>`;

            return `
                <div class="source-pill flex items-center gap-2 bg-slate-100 text-slate-700 text-sm px-3 py-1.5 rounded-full" data-index="${index}">
                    <span class="flex-shrink-0">${icon}</span>
                    <div class="flex-grow truncate">${content}</div>
                    <div class="source-actions flex items-center gap-2">
                        <button class="edit-source-btn text-slate-500 hover:text-blue-600">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                        <button class="delete-source-btn text-slate-500 hover:text-red-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                        </button>
                    </div>
                </div>
            `;
        }


        function createLerninhaltItem(topicId, inhalt, index) {
            const currentStatus = statusOptions.find(opt => opt.Status === inhalt.status) || statusOptions[0];
            return `
            <div class="flex items-center justify-between lerninhalt-item" data-topic-id="${topicId}" data-inhalt-index="${index}">
                <span class="text-sm text-slate-700 flex-grow">${inhalt.text}</span>
                <div class="individual-selector status-selector">
                    <button class="status-selector-button flex items-center text-xs font-semibold border border-slate-300 rounded-full px-3 py-1 hover:bg-slate-100 transition-colors">
                        <span class="status-dot ${currentStatus.color}"></span>
                        <span class="status-text">${currentStatus.Status}</span>
                        <svg class="w-4 h-4 ml-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="status-options">
                        ${statusOptions.map(option => `
                            <div class="status-option" data-status="${option.Status}">
                                <span class="status-dot ${option.color}"></span>
                                <span>${option.Status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
        }

        function addEventListeners() {
            document.body.addEventListener('click', function(event) {
                const accordionButton = event.target.closest('.accordion-button');
                if (accordionButton) {
                    const content = accordionButton.parentElement.querySelector('.accordion-content');
                    const isExpanded = accordionButton.classList.contains('open');
                    
                    if (content.transitionTimeout) clearTimeout(content.transitionTimeout);

                    if (isExpanded) {
                        content.style.overflow = 'hidden';
                        accordionButton.classList.remove('open');
                        accordionButton.querySelector('.chevron-icon').classList.remove('rotate-180');
                    } else {
                        accordionButton.classList.add('open');
                        accordionButton.querySelector('.chevron-icon').classList.add('rotate-180');
                        content.transitionTimeout = setTimeout(() => {
                            content.style.overflow = 'visible';
                        }, 500);
                    }
                }

                const statusButton = event.target.closest('.status-selector-button');
                if (statusButton) {
                    event.stopPropagation();
                    const options = statusButton.nextElementSibling;
                    document.querySelectorAll('.status-options.visible').forEach(opt => {
                        if (opt !== options) opt.classList.remove('visible');
                    });
                    options.classList.toggle('visible');
                    return;
                }

                const statusOption = event.target.closest('.status-option');
                if (statusOption) {
                    const newStatus = statusOption.dataset.status;
                    const selector = statusOption.closest('.status-selector');
                    const currentStatusInfo = statusOptions.find(opt => opt.Status === newStatus);

                    if (selector.classList.contains('section-master-selector')) {
                        const bereich = selector.dataset.identifier;
                        const card = selector.closest('.card');
                        topicsData.filter(t => t.Bereich === bereich).forEach(topic => {
                            topic.Lerninhalte.forEach(inhalt => inhalt.status = newStatus);
                        });
                        card.querySelectorAll('.individual-selector .status-selector-button').forEach(button => {
                            button.querySelector('.status-dot').className = `status-dot ${currentStatusInfo.color}`;
                            button.querySelector('.status-text').textContent = currentStatusInfo.Status;
                        });

                    } else if (selector.classList.contains('topic-master-selector')) {
                        const topicId = selector.dataset.identifier;
                        const topicItem = selector.closest('.topic-item');
                        const topic = topicsData.find(t => t.id === topicId);
                        if (topic) {
                            topic.Lerninhalte.forEach(inhalt => inhalt.status = newStatus);
                            topicItem.querySelectorAll('.individual-selector .status-selector-button').forEach(button => {
                                button.querySelector('.status-dot').className = `status-dot ${currentStatusInfo.color}`;
                                button.querySelector('.status-text').textContent = currentStatusInfo.Status;
                            });
                        }
                    } else {
                        const item = selector.closest('.lerninhalt-item');
                        const topicId = item.dataset.topicId;
                        const inhaltIndex = parseInt(item.dataset.inhaltIndex);
                        const topic = topicsData.find(t => t.id === topicId);
                        if (topic && topic.Lerninhalte[inhaltIndex]) {
                            topic.Lerninhalte[inhaltIndex].status = newStatus;
                            const button = selector.querySelector('.status-selector-button');
                            button.querySelector('.status-dot').className = `status-dot ${currentStatusInfo.color}`;
                            button.querySelector('.status-text').textContent = currentStatusInfo.Status;
                        }
                    }

                    updateAllProgress();
                    saveStateToFirestore();
                    selector.querySelector('.status-options').classList.remove('visible');
                    return;
                }
                
                const addSourceBtn = event.target.closest('.add-source-btn');
                if (addSourceBtn) {
                    const topicItem = addSourceBtn.closest('.topic-item');
                    const form = topicItem.querySelector('.add-source-form');
                    form.dataset.editingIndex = '-1'; // Asegura que está en modo "añadir"
                    form.querySelector('.source-description-input').value = '';
                    form.querySelector('.source-link-input').value = '';
                    form.classList.remove('hidden');
                    addSourceBtn.classList.add('hidden');
                }

                const cancelSourceBtn = event.target.closest('.cancel-source-btn');
                if (cancelSourceBtn) {
                    const topicItem = cancelSourceBtn.closest('.topic-item');
                    const form = topicItem.querySelector('.add-source-form');
                    form.classList.add('hidden');
                    form.querySelector('.source-description-input').value = '';
                    form.querySelector('.source-link-input').value = '';
                    topicItem.querySelector('.add-source-btn').classList.remove('hidden');
                }

                const saveSourceBtn = event.target.closest('.save-source-btn');
                if (saveSourceBtn) {
                    const topicItem = saveSourceBtn.closest('.topic-item');
                    const topicId = topicItem.dataset.topicId;
                    const topic = topicsData.find(t => t.id === topicId);
                    const form = topicItem.querySelector('.add-source-form');
                    const descriptionInput = form.querySelector('.source-description-input');
                    const linkInput = form.querySelector('.source-link-input');
                    const editingIndex = parseInt(form.dataset.editingIndex);

                    if (topic && descriptionInput.value.trim() !== '') {
                        const newSource = {
                            description: descriptionInput.value.trim(),
                            link: linkInput.value.trim()
                        };

                        if (editingIndex > -1) {
                            // Modo Edición
                            topic.Quellen[editingIndex] = newSource;
                        } else {
                            // Modo Añadir
                            topic.Quellen.push(newSource);
                        }
                        
                        const sourcesContainer = topicItem.querySelector('.sources-container');
                        sourcesContainer.innerHTML = topic.Quellen.map((source, index) => createSourcePill(source, index)).join('');
                        
                        const cancelBtn = topicItem.querySelector('.cancel-source-btn');
                        if (cancelBtn) {
                            cancelBtn.click();
                        }
                        saveStateToFirestore();
                    }
                }

                const deleteSourceBtn = event.target.closest('.delete-source-btn');
                if (deleteSourceBtn) {
                    const pill = deleteSourceBtn.closest('.source-pill');
                    const topicItem = deleteSourceBtn.closest('.topic-item');
                    const topicId = topicItem.dataset.topicId;
                    const topic = topicsData.find(t => t.id === topicId);
                    const sourceIndex = parseInt(pill.dataset.index);

                    if (topic && topic.Quellen[sourceIndex]) {
                        topic.Quellen.splice(sourceIndex, 1);
                        const sourcesContainer = topicItem.querySelector('.sources-container');
                        sourcesContainer.innerHTML = topic.Quellen.map((source, index) => createSourcePill(source, index)).join('');
                        saveStateToFirestore();
                    }
                }

                const editSourceBtn = event.target.closest('.edit-source-btn');
                if (editSourceBtn) {
                    const pill = editSourceBtn.closest('.source-pill');
                    const topicItem = editSourceBtn.closest('.topic-item');
                    const topicId = topicItem.dataset.topicId;
                    const topic = topicsData.find(t => t.id === topicId);
                    const sourceIndex = parseInt(pill.dataset.index);

                    if (topic && topic.Quellen[sourceIndex]) {
                        const source = topic.Quellen[sourceIndex];
                        const form = topicItem.querySelector('.add-source-form');
                        form.querySelector('.source-description-input').value = source.description;
                        form.querySelector('.source-link-input').value = source.link || '';
                        form.dataset.editingIndex = sourceIndex;

                        form.classList.remove('hidden');
                        topicItem.querySelector('.add-source-btn').classList.add('hidden');
                    }
                }


                document.querySelectorAll('.status-options.visible').forEach(options => {
                    if (!options.previousElementSibling.contains(event.target)) {
                        options.classList.remove('visible');
                    }
                });
            });

            document.body.addEventListener('change', function(event) {
                if (event.target.classList.contains('milestone-checkbox')) {
                    const checkbox = event.target;
                    const index = parseInt(checkbox.dataset.index);
                    if (projectMilestones[index]) {
                        projectMilestones[index].completed = checkbox.checked;
                    }
                    updateProjectProgress();
                    saveStateToFirestore();
                }
            });
        }

        function getTopicBarColor(percentage) {
            if (percentage === 100) return 'bg-gradient-to-r from-teal-400 to-emerald-500';
            if (percentage > 0) return 'bg-gradient-to-r from-sky-400 to-blue-500';
            return 'bg-slate-300';
        }

        function updateProjectProgress() {
            const completedCount = projectMilestones.filter(m => m.completed).length;
            const progress = projectMilestones.length > 0 ? (completedCount / projectMilestones.length) * 100 : 0;
            document.getElementById('project-milestone-progress-bar').style.width = `${progress}%`;
            document.getElementById('project-milestone-progress-text').textContent = `${Math.round(progress)}%`;
        }

        function updateAllProgress() {
            let overallProgressSum = 0;
            let totalLerninhalte = 0;

            document.querySelectorAll('#accordion-container .card').forEach((card, index) => {
                const sectionId = `section-${index}`;
                const topicItems = card.querySelectorAll('.topic-item');
                if (topicItems.length === 0) return;

                let sectionProgressSum = 0;
                let sectionLerninhalteCount = 0;

                topicItems.forEach(item => {
                    const topicId = item.dataset.topicId;
                    const topic = topicsData.find(t => t.id === topicId);
                    if (!topic) return;

                    let topicProgressSum = 0;
                    topic.Lerninhalte.forEach(inhalt => {
                        const statusInfo = statusOptions.find(s => s.Status === inhalt.status);
                        topicProgressSum += statusInfo ? statusInfo.Percent : 0;
                    });
                    
                    const topicAverage = topic.Lerninhalte.length > 0 ? Math.round(topicProgressSum / topic.Lerninhalte.length) : 0;
                    const topicProgressBar = item.querySelector('.topic-progress-bar');
                    if(topicProgressBar) {
                        topicProgressBar.style.width = `${topicAverage}%`;
                        const newColorClass = getTopicBarColor(topicAverage);
                        topicProgressBar.className = `topic-progress-bar progress-bar-fill h-2 rounded-full ${newColorClass}`;
                    }
                    
                    const topicProgressText = item.querySelector('.topic-progress-text');
                    if(topicProgressText) {
                        topicProgressText.textContent = `${topicAverage}%`;
                    }

                    sectionProgressSum += topicProgressSum;
                    sectionLerninhalteCount += topic.Lerninhalte.length;
                });

                const sectionProgressBar = document.getElementById(`progress-bar-${sectionId}`);
                if (sectionProgressBar) {
                    const sectionAverage = sectionLerninhalteCount > 0 ? Math.round(sectionProgressSum / sectionLerninhalteCount) : 0;
                    sectionProgressBar.style.width = `${sectionAverage}%`;
                }

                overallProgressSum += sectionProgressSum;
                totalLerninhalte += sectionLerninhalteCount;
            });

            const overallProgressBar = document.getElementById('overall-progress-bar');
            const overallProgressText = document.getElementById('overall-progress-text');
            if(overallProgressBar && overallProgressText) {
                const overallAverage = totalLerninhalte > 0 ? Math.round(overallProgressSum / totalLerninhalte) : 0;
                overallProgressBar.style.width = `${overallAverage}%`;
                overallProgressText.textContent = `${overallAverage}%`;
            }
        }
    </script>
</body>
</html>
